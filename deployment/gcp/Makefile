# R2R GCP Deployment Makefile
# –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —Ä–∞–∑–≤–µ—Ä—Ç—ã–≤–∞–Ω–∏–µ–º R2R Full Mode –Ω–∞ Google Cloud Platform

# –ü–µ—Ä–µ–º–µ–Ω–Ω—ã–µ
PROJECT_ID := r2r-full-deployment
ZONE := us-central1-a
VM_NAME := r2r-production
VM_IP := 136.119.36.216
MACHINE_TYPE := n1-standard-4
DISK_SIZE := 200
DOCKER_DIR := ~/R2R/docker

.PHONY: help
help:  ## –ü–æ–∫–∞–∑–∞—Ç—å —ç—Ç—É —Å–ø—Ä–∞–≤–∫—É
	@echo "R2R GCP Deployment Commands:"
	@echo ""
	@grep -E '^[a-zA-Z_-]+:.*?## .*$$' $(MAKEFILE_LIST) | sort | awk 'BEGIN {FS = ":.*?## "}; {printf "  \033[36m%-20s\033[0m %s\n", $$1, $$2}'

## === VM Management ===

.PHONY: vm-create
vm-create:  ## –°–æ–∑–¥–∞—Ç—å Compute Engine VM
	gcloud compute instances create $(VM_NAME) \
	  --project=$(PROJECT_ID) \
	  --zone=$(ZONE) \
	  --machine-type=$(MACHINE_TYPE) \
	  --create-disk=auto-delete=yes,boot=yes,device-name=$(VM_NAME),image=projects/ubuntu-os-cloud/global/images/ubuntu-2204-jammy-v20251111,mode=rw,size=$(DISK_SIZE),type=pd-balanced \
	  --network-interface=network-tier=PREMIUM,stack-type=IPV4_ONLY,subnet=default \
	  --maintenance-policy=MIGRATE \
	  --tags=r2r-server,http-server \
	  --labels=env=production,app=r2r

.PHONY: vm-delete
vm-delete:  ## –£–¥–∞–ª–∏—Ç—å VM
	gcloud compute instances delete $(VM_NAME) \
	  --zone=$(ZONE) \
	  --project=$(PROJECT_ID) \
	  --quiet

.PHONY: vm-start
vm-start:  ## –ó–∞–ø—É—Å—Ç–∏—Ç—å –æ—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–Ω—É—é VM
	gcloud compute instances start $(VM_NAME) \
	  --zone=$(ZONE) \
	  --project=$(PROJECT_ID)

.PHONY: vm-stop
vm-stop:  ## –û—Å—Ç–∞–Ω–æ–≤–∏—Ç—å VM
	gcloud compute instances stop $(VM_NAME) \
	  --zone=$(ZONE) \
	  --project=$(PROJECT_ID)

.PHONY: vm-ssh
vm-ssh:  ## SSH –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∫ VM
	gcloud compute ssh $(VM_NAME) \
	  --zone=$(ZONE) \
	  --project=$(PROJECT_ID)

.PHONY: vm-status
vm-status:  ## –ü—Ä–æ–≤–µ—Ä–∏—Ç—å —Å—Ç–∞—Ç—É—Å VM
	gcloud compute instances describe $(VM_NAME) \
	  --zone=$(ZONE) \
	  --project=$(PROJECT_ID) \
	  --format="table(name,status,networkInterfaces[0].accessConfigs[0].natIP)"

## === Firewall Rules ===

.PHONY: firewall-create
firewall-create:  ## –°–æ–∑–¥–∞—Ç—å Firewall Rules –¥–ª—è R2R
	gcloud compute firewall-rules create allow-r2r-services \
	  --project=$(PROJECT_ID) \
	  --direction=INGRESS \
	  --priority=1000 \
	  --network=default \
	  --action=ALLOW \
	  --rules=tcp:7272-7276,tcp:22 \
	  --source-ranges=0.0.0.0/0 \
	  --target-tags=r2r-server

.PHONY: firewall-delete
firewall-delete:  ## –£–¥–∞–ª–∏—Ç—å Firewall Rules
	gcloud compute firewall-rules delete allow-r2r-services \
	  --project=$(PROJECT_ID) \
	  --quiet

.PHONY: firewall-list
firewall-list:  ## –ü–æ–∫–∞–∑–∞—Ç—å Firewall Rules
	gcloud compute firewall-rules list \
	  --project=$(PROJECT_ID) \
	  --filter="targetTags:r2r-server"

## === Docker Management ===

.PHONY: docker-install
docker-install:  ## –£—Å—Ç–∞–Ω–æ–≤–∏—Ç—å Docker –Ω–∞ VM
	gcloud compute ssh $(VM_NAME) --zone=$(ZONE) --project=$(PROJECT_ID) --command=' \
	  sudo apt-get update -qq && \
	  sudo apt-get install -y -qq ca-certificates curl git && \
	  sudo install -m 0755 -d /etc/apt/keyrings && \
	  sudo curl -fsSL https://download.docker.com/linux/ubuntu/gpg -o /etc/apt/keyrings/docker.asc && \
	  sudo chmod a+r /etc/apt/keyrings/docker.asc && \
	  echo "deb [arch=$(dpkg --print-architecture) signed-by=/etc/apt/keyrings/docker.asc] https://download.docker.com/linux/ubuntu $(. /etc/os-release && echo \"$$VERSION_CODENAME\") stable" | sudo tee /etc/apt/sources.list.d/docker.list > /dev/null && \
	  sudo apt-get update -qq && \
	  sudo apt-get install -y -qq docker-ce docker-ce-cli containerd.io docker-buildx-plugin docker-compose-plugin && \
	  sudo usermod -aG docker $$USER && \
	  docker --version && docker compose version'

## === R2R Deployment ===

.PHONY: r2r-deploy
r2r-deploy:  ## –†–∞–∑–≤–µ—Ä–Ω—É—Ç—å R2R Full Mode
	gcloud compute ssh $(VM_NAME) --zone=$(ZONE) --project=$(PROJECT_ID) --command=' \
	  cd $(DOCKER_DIR) && \
	  docker compose -f compose.full.yaml --profile postgres up -d'

.PHONY: r2r-stop
r2r-stop:  ## –û—Å—Ç–∞–Ω–æ–≤–∏—Ç—å R2R
	gcloud compute ssh $(VM_NAME) --zone=$(ZONE) --project=$(PROJECT_ID) --command=' \
	  cd $(DOCKER_DIR) && \
	  docker compose -f compose.full.yaml down'

.PHONY: r2r-restart
r2r-restart:  ## –ü–µ—Ä–µ–∑–∞–ø—É—Å—Ç–∏—Ç—å R2R
	gcloud compute ssh $(VM_NAME) --zone=$(ZONE) --project=$(PROJECT_ID) --command=' \
	  cd $(DOCKER_DIR) && \
	  docker compose -f compose.full.yaml down && \
	  docker compose -f compose.full.yaml --profile postgres up -d'

.PHONY: r2r-clean
r2r-clean:  ## –û—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –∏ –æ—á–∏—Å—Ç–∏—Ç—å volumes
	gcloud compute ssh $(VM_NAME) --zone=$(ZONE) --project=$(PROJECT_ID) --command=' \
	  cd $(DOCKER_DIR) && \
	  docker compose -f compose.full.yaml down -v && \
	  docker volume prune -f'

.PHONY: r2r-redeploy
r2r-redeploy:  ## –ü–æ–ª–Ω—ã–π —Ä–µ—Å—Ç–∞—Ä—Ç —Å –æ—á–∏—Å—Ç–∫–æ–π volumes
	gcloud compute ssh $(VM_NAME) --zone=$(ZONE) --project=$(PROJECT_ID) --command=' \
	  cd $(DOCKER_DIR) && \
	  docker compose -f compose.full.yaml down -v && \
	  docker volume rm hatchet_postgres_data 2>/dev/null || true && \
	  docker volume prune -f && \
	  docker compose -f compose.full.yaml --profile postgres up -d'

## === Monitoring ===

.PHONY: status
status:  ## –ü–æ–∫–∞–∑–∞—Ç—å —Å—Ç–∞—Ç—É—Å –≤—Å–µ—Ö —Å–µ—Ä–≤–∏—Å–æ–≤
	gcloud compute ssh $(VM_NAME) --zone=$(ZONE) --project=$(PROJECT_ID) --command=' \
	  cd $(DOCKER_DIR) && \
	  docker compose -f compose.full.yaml ps'

.PHONY: status-all
status-all:  ## –ü–æ–∫–∞–∑–∞—Ç—å —Å—Ç–∞—Ç—É—Å –≤—Å–µ—Ö –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–æ–≤ (–≤–∫–ª—é—á–∞—è –æ—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–Ω—ã–µ)
	gcloud compute ssh $(VM_NAME) --zone=$(ZONE) --project=$(PROJECT_ID) --command=' \
	  cd $(DOCKER_DIR) && \
	  docker compose -f compose.full.yaml ps -a'

.PHONY: logs
logs:  ## –ü–æ–∫–∞–∑–∞—Ç—å –ª–æ–≥–∏ R2R (tail 50)
	gcloud compute ssh $(VM_NAME) --zone=$(ZONE) --project=$(PROJECT_ID) --command=' \
	  cd $(DOCKER_DIR) && \
	  docker compose -f compose.full.yaml logs --tail=50 r2r'

.PHONY: logs-follow
logs-follow:  ## –°–ª–µ–¥–∏—Ç—å –∑–∞ –ª–æ–≥–∞–º–∏ R2R –≤ —Ä–µ–∞–ª—å–Ω–æ–º –≤—Ä–µ–º–µ–Ω–∏
	gcloud compute ssh $(VM_NAME) --zone=$(ZONE) --project=$(PROJECT_ID) --command=' \
	  cd $(DOCKER_DIR) && \
	  docker compose -f compose.full.yaml logs -f r2r'

.PHONY: logs-hatchet
logs-hatchet:  ## –ü–æ–∫–∞–∑–∞—Ç—å –ª–æ–≥–∏ Hatchet
	gcloud compute ssh $(VM_NAME) --zone=$(ZONE) --project=$(PROJECT_ID) --command=' \
	  cd $(DOCKER_DIR) && \
	  docker compose -f compose.full.yaml logs --tail=50 hatchet-engine'

.PHONY: logs-all
logs-all:  ## –ü–æ–∫–∞–∑–∞—Ç—å –ª–æ–≥–∏ –≤—Å–µ—Ö —Å–µ—Ä–≤–∏—Å–æ–≤
	gcloud compute ssh $(VM_NAME) --zone=$(ZONE) --project=$(PROJECT_ID) --command=' \
	  cd $(DOCKER_DIR) && \
	  docker compose -f compose.full.yaml logs --tail=30'

.PHONY: stats
stats:  ## –ü–æ–∫–∞–∑–∞—Ç—å –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ —Ä–µ—Å—É—Ä—Å–æ–≤
	gcloud compute ssh $(VM_NAME) --zone=$(ZONE) --project=$(PROJECT_ID) --command=' \
	  docker stats --no-stream --format "table {{.Container}}\t{{.CPUPerc}}\t{{.MemUsage}}"'

## === Health Checks ===

.PHONY: health
health:  ## –ü—Ä–æ–≤–µ—Ä–∏—Ç—å health R2R API
	@echo "–ü—Ä–æ–≤–µ—Ä–∫–∞ R2R API health:"
	@curl -s http://$(VM_IP):7272/v3/health || echo "API –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω"

.PHONY: health-all
health-all:  ## –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –≤—Å–µ endpoints
	@echo "R2R API (7272):"
	@curl -s http://$(VM_IP):7272/v3/health | head -5 || echo "  ‚ùå –ù–µ–¥–æ—Å—Ç—É–ø–µ–Ω"
	@echo ""
	@echo "R2R Dashboard (7273):"
	@curl -s -o /dev/null -w "  Status: %{http_code}\n" http://$(VM_IP):7273 || echo "  ‚ùå –ù–µ–¥–æ—Å—Ç—É–ø–µ–Ω"
	@echo ""
	@echo "Hatchet Dashboard (7274):"
	@curl -s -o /dev/null -w "  Status: %{http_code}\n" http://$(VM_IP):7274 || echo "  ‚ùå –ù–µ–¥–æ—Å—Ç—É–ø–µ–Ω"

## === Configuration ===

.PHONY: config-sync
config-sync:  ## –°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∏—Ä–æ–≤–∞—Ç—å –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—é –Ω–∞ VM
	gcloud compute scp docker/user_configs/gemini-openai.toml \
	  $(VM_NAME):~/R2R/docker/user_configs/ \
	  --zone=$(ZONE) \
	  --project=$(PROJECT_ID)

.PHONY: config-show
config-show:  ## –ü–æ–∫–∞–∑–∞—Ç—å —Ç–µ–∫—É—â—É—é –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—é –Ω–∞ VM
	gcloud compute ssh $(VM_NAME) --zone=$(ZONE) --project=$(PROJECT_ID) --command=' \
	  cat ~/R2R/docker/user_configs/gemini-openai.toml'

## === Quick Deploy (Full Setup) ===

.PHONY: deploy-full
deploy-full:  ## –ü–æ–ª–Ω–æ–µ —Ä–∞–∑–≤–µ—Ä—Ç—ã–≤–∞–Ω–∏–µ —Å –Ω—É–ª—è
	@echo "üöÄ –ù–∞—á–∞–ª–æ –ø–æ–ª–Ω–æ–≥–æ —Ä–∞–∑–≤–µ—Ä—Ç—ã–≤–∞–Ω–∏—è R2R..."
	@echo ""
	@echo "1Ô∏è‚É£ –°–æ–∑–¥–∞–Ω–∏–µ VM..."
	@make vm-create
	@echo ""
	@echo "2Ô∏è‚É£ –°–æ–∑–¥–∞–Ω–∏–µ Firewall Rules..."
	@make firewall-create
	@echo ""
	@echo "3Ô∏è‚É£ –£—Å—Ç–∞–Ω–æ–≤–∫–∞ Docker (–ø–æ–¥–æ–∂–¥–∏—Ç–µ 2 –º–∏–Ω—É—Ç—ã)..."
	@sleep 120
	@make docker-install
	@echo ""
	@echo "4Ô∏è‚É£ –ö–ª–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ R2R..."
	@gcloud compute ssh $(VM_NAME) --zone=$(ZONE) --project=$(PROJECT_ID) --command='git clone https://github.com/SciPhi-AI/R2R.git ~/R2R'
	@echo ""
	@echo "5Ô∏è‚É£ –°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏..."
	@make config-sync
	@echo ""
	@echo "6Ô∏è‚É£ –ó–∞–ø—É—Å–∫ R2R..."
	@make r2r-deploy
	@echo ""
	@echo "‚úÖ –†–∞–∑–≤–µ—Ä—Ç—ã–≤–∞–Ω–∏–µ –∑–∞–≤–µ—Ä—à–µ–Ω–æ!"
	@echo ""
	@echo "üåê –î–æ—Å—Ç—É–ø –∫ —Å–µ—Ä–≤–∏—Å–∞–º:"
	@echo "  R2R API:          http://$(VM_IP):7272"
	@echo "  R2R Dashboard:    http://$(VM_IP):7273"
	@echo "  Hatchet Dashboard: http://$(VM_IP):7274"

## === Cleanup ===

.PHONY: destroy-all
destroy-all:  ## –£–¥–∞–ª–∏—Ç—å –≤—Å–µ (VM + Firewall)
	@echo "‚ö†Ô∏è  –£–¥–∞–ª–µ–Ω–∏–µ –≤—Å–µ–π –∏–Ω—Ñ—Ä–∞—Å—Ç—Ä—É–∫—Ç—É—Ä—ã..."
	@make vm-delete
	@make firewall-delete
	@echo "‚úÖ –í—Å–µ —É–¥–∞–ª–µ–Ω–æ!"
