name: R2R CLI Integration (ubuntu latest)

on:
  pull_request:
    branches:
      - 'dev*'
      - 'dev-minor*'
  push:
    branches:
      - 'dev*'
      - 'dev-minor*'

jobs:
  build-and-test:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      id-token: write
      actions: write
    env:
      OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
      TELEMETRY_ENABLED: false
      POSTGRES_HOST: localhost
      POSTGRES_DBNAME: postgres
      POSTGRES_PORT: 5432
      POSTGRES_PASSWORD: postgres
      POSTGRES_USER: postgres

    steps:
      - name: Install and configure PostgreSQL
        run: |
          sudo apt-get update
          sudo apt-get install -y postgresql
          sudo systemctl start postgresql.service
          sudo -u postgres psql -c "ALTER USER postgres PASSWORD 'postgres';"

      # Add your other steps here

      - name: Cleanup PostgreSQL
        if: always()  # Run this step even if the job fails
        run: |
          sudo systemctl stop postgresql.service
          sudo rm -rf /var/lib/postgresql/          